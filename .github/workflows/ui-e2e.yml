name: UI e2e tests on demand

on:
  workflow_dispatch:
  issue_comment:
    types: [created]

env:
  REGISTRY: quay.io
  QUAY_USER: ansible+eda_gha
  EDA_API_URL: "http://eda-api:8000"
  EDA_UI_URL: "https://eda-ui"
  DOCKER_NETWORK: service-mesh
  UI_E2E_IMAGE: "quay.io/ansible/ui-e2e"

jobs:
  check-trigger:
    if: >
      github.repository == 'kaiokmo/eda-server' &&
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      github.event.comment.body == '/run-ui-e2e'
    runs-on: ubuntu-latest
    outputs:
      pr_sha: ${{ steps.pr-info.outputs.sha }}
      pr_repo: ${{ steps.pr-info.outputs.repo }}
      pr_number: ${{ steps.pr-info.outputs.number }}
      deployment_id: ${{ steps.create-deployment.outputs.deployment_id }}
    steps:
      - name: Check if commenter has write access
        id: check-permission
        uses: actions/github-script@v7
        with:
          script: |
            const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              username: context.payload.comment.user.login
            });
            const allowed = ['admin', 'write'].includes(permission.permission);
            if (!allowed) {
              core.setFailed(`User ${context.payload.comment.user.login} does not have write access`);
            }
            console.log(`User ${context.payload.comment.user.login} has ${permission.permission} permission`);

      - name: Get PR info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            core.setOutput('sha', pr.data.head.sha);
            core.setOutput('repo', pr.data.head.repo.full_name);
            core.setOutput('number', context.issue.number);
            console.log(`PR #${context.issue.number} head SHA: ${pr.data.head.sha}`);
            console.log(`PR head repo: ${pr.data.head.repo.full_name}`);

      - name: Create deployment
        id: create-deployment
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const deployment = await github.rest.repos.createDeployment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: 'refs/pull/${{ steps.pr-info.outputs.number }}/head',
                environment: 'ui-e2e-tests',
                auto_merge: false,
                required_contexts: [],
                description: 'UI E2E Tests for PR #${{ steps.pr-info.outputs.number }} @ ${{ steps.pr-info.outputs.sha }}'
              });
              
              if (deployment.data && deployment.data.id) {
                core.setOutput('deployment_id', deployment.data.id);
                
                await github.rest.repos.createDeploymentStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  deployment_id: deployment.data.id,
                  state: 'pending',
                  description: 'Waiting for approval',
                  log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
                });
                console.log(`Created deployment ${deployment.data.id}`);
              } else {
                core.warning('Deployment was not created - response had no ID');
                core.setOutput('deployment_id', '');
              }
            } catch (error) {
              core.warning(`Failed to create deployment: ${error.message}`);
              core.setOutput('deployment_id', '');
            }

  ui-e2e-tests:
    needs: check-trigger
    if: >
      always() &&
      (github.repository == 'kaiokmo/eda-server' && github.event_name == 'workflow_dispatch') ||
      (needs.check-trigger.result == 'success')
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'issue_comment' && 'protected' || '' }}
    steps:
      - name: Update deployment to in_progress
        if: github.event_name == 'issue_comment' && needs.check-trigger.outputs.deployment_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: '${{ needs.check-trigger.outputs.deployment_id }}',
              state: 'in_progress',
              description: 'Running UI E2E tests',
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });

      - name: Checkout
        uses: actions/checkout@v6
        with:
          repository: ${{ github.event_name == 'issue_comment' && needs.check-trigger.outputs.pr_repo || github.repository }}
          ref: ${{ github.event_name == 'issue_comment' && needs.check-trigger.outputs.pr_sha || github.sha }}

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.QUAY_USER }}
          password: ${{ secrets.QUAY_PASSWORD }}

      - name: Run api in background
        working-directory: .
        env:
          DJANGO_SETTINGS_MODULE: aap_eda.settings.default
          EDA_DEBUG: "false"
        run: |
          docker compose -p eda -f tools/docker/docker-compose-dev.yaml build
          docker compose -p eda -f tools/docker/docker-compose-dev.yaml up -d
          while ! curl -s http://localhost:8000/_healthz | grep -q "OK"; do
            echo "Waiting for API to be ready..."
            sleep 1
          done

      - name: Run UI E2E Tests
        run: |
          docker run --rm \
          -e EDA_SERVER=${{ env.EDA_API_URL }} \
          -e EDA_USERNAME=${{ secrets.EDA_USERNAME }} \
          -e EDA_PASSWORD=${{ secrets.EDA_PASSWORD }} \
          -e CYPRESS_baseUrl=${{ env.EDA_UI_URL }} \
          -e CYPRESS_E2E_MODE=EDA \
          -e NODE_OPTIONS=--max-old-space-size=3500 \
          --network ${{ env.DOCKER_NETWORK }} \
          ${{ env.UI_E2E_IMAGE }} \
          ./node_modules/.bin/cypress run --config-file=cypress.eda.config.ts --headless

      - name: Update deployment status
        if: always() && github.event_name == 'issue_comment' && needs.check-trigger.outputs.deployment_id != ''
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: '${{ needs.check-trigger.outputs.deployment_id }}',
              state: state,
              log_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
            });
